### Chapter3.如何建模服务

1. 什么样的服务是好服务

   + **松耦合**：如果做到了服务之间的松耦合，那么修改一个服务就不需要修改另一个服务。使用微服务最重要的一点是，能够独立修改及部署单个服务而不需要修改系统的其他部分。一个松耦合的服务应该尽可能少地知道与之协作的那些服务的信息。这也意味着，应该限制两个服务之间不同调用形式的数量，因为除了潜在的性能问题之外，过度的通信可能会导致紧耦合。
   + **高内聚**：把相关的行为聚集在一起，把不相关的行为放在别处。如果你要改变某个行为的话，最好能够只在一个地方进行修改，然后就可以尽快地发布。如果需要在很多不同的地方做这些修改，那么可能就需要同时发布多个微服务才能交付这个功能。在多个不同的地方进行修改会很慢，同时部署多个服务风险也很高，这两者都是我们想要避免的。所以，找到问题域的边界就可以确保相关的行为能放在同一个地方，并且它们会把其他边界以尽量松耦合的形式进行通信。

2. 限界上下文：任何一个给定的领域都包含多个限界上下文，每个限界上下文的东西分成两部分，一部分不需要与外部通信，另一部分则需要。每个上下文都有明确的接口，该接口决定了它会暴露哪些模型给其他的上下文。

3. 共享的隐藏模型：比如仓库和财务共享同一个共享模型“库存项”。

4. 模块和服务：明白应该共享特定的模型，而不应该共享内部表示这个道理之后，就可以避免潜在的紧耦合（即我们不希望成为的样子）风险。我们还识别出了领域内的一些边界，边界内部是相关性比较高的业务功能，从而得到高内聚。这些限界上下文可以很好地形成组合边界。

   + 一般来说，微服务应该清晰地和限界上下文保持一致。熟练之后，就可以省掉在单块系统中先使用模块的这个步骤，而直接使用单独的服务。然而对于一个新系统而言，可以先使用一段时间的单块系统，因为如果服务之间的边界搞错了，后面修复的代价会很大。所以最好能够等到系统稳定下来之后，再确定把哪些东西作为一个服务划分出去。
   + 所以，如果服务边界和领域的限界上下文能保持一致，并且微服务可以很好地表示这些限界上下文的话，恭喜你，你跨出了走向高内聚低耦合的微服务架构的第一步。

5. 过早划分：过早地将一个系统划分成为微服务的代价非常高，尤其是在面对新领域时。很多时候，将一个已有的代码库划分成微服务，要比从头开始构建微服务简单得多。

6. 业务功能：当你在思考组织内的限界上下文时，不应该从共享数据的角度来考虑，而应该从这些上下文能够提供的功能来考虑。首先要问自己“这个上下文是做什么用的”，然后再考虑“它需要什么样的数据”。

7. 逐步划分上下文：一开始你会识别出一些粗粒度的限界上下文，而这些限界上下文可能又包含一些嵌套的限界上下文。当考虑微服务的边界时，首先考虑比较大的，粗粒度的那些上下文，然后当发现合适的缝隙后，再进一步划分出那些嵌套的上下文。当时这里划分方案也有两种：

   + 在仓库内部使用微服务表示嵌套限界上下文（仓库单独做一个服务，里面包含订单处理，货物接收和库存管理）；
   + 仓库内部的限界上下文被提升到顶层上下文的层次（订单处理，货物接收和库存管理单独拆成三个微服务）；

   通常很难说哪种规则更合理，但是你应该根据组织结构来决定，到底是使用嵌套的方法还是完全分离的方法。看这里面的服务是不是同一个团队进行管理，组织架构和软件架构会相互影响。

8. 关于业务概念的沟通

   修改系统的目的是为了满足业务需求。我们会修改面向客户的功能。如果把系统分解成为限界上下文来表示领域的话，那么对于某个功能所要做的修改，就更倾向于局限在一个单独的微服务边界之内。这样就减少了修改的范围，并能够更快地进行部署。

   微服务之间如何就同一个业务概念进行通信，也是一件很重要的事情。基于业务领域的软件建模不应该止于限界上下文的概念。在组织内部共享的那些相同的术语和想法，也应该被反映到服务的接口上。以跟组织内通信相同的方式，来思考微服务之间的通信形式是非常有用的。事实上，通信形式在整个组织范围内都非常重要。

9. 技术边界：

   + “洋葱架构”的认识，虽然层次十分清晰，但是当做出纵切层次的操作时，会相当痛苦；
   + 按照技术接缝对服务边界进行建模也并不总是错误的。比如，我见过当一个组织想要达到某个性能目标是，这种划分方式反而更合理。然而一般来讲，这不应该成为考虑的首要方式。